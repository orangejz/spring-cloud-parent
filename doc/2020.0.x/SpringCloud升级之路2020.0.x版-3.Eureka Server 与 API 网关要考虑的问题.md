![](https://zhxhash-blog.oss-cn-beijing.aliyuncs.com/Spring%20Cloud%20%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF/2020.x/Spring%20Cloud%20%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF%20Logo.jpg)

> 本系列为之前系列的整理重启版，随着项目的发展以及项目中的使用，之前系列里面很多东西发生了变化，并且还有一些东西之前系列并没有提到，所以重启这个系列重新整理下，欢迎各位留言交流，谢谢！~

![](https://zhxhash-blog.oss-cn-beijing.aliyuncs.com/Spring%20Cloud%20%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF/2020.x/3-01.%20%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%20Eureka%20%E9%9C%80%E8%A6%81%E8%80%83%E8%99%91%E7%9A%84%E9%97%AE%E9%A2%98.jpg)

之前我们提到了，不同的集群，使用的是同一套 Eureka 集群。

我们会动态在线发布每个微服务，在 K8s 的环境下，我们一般使用 ReplicaSet 将我们的微服务部署成无状态的微服务实例（参考：[ReplicaSet](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/)）；在这种情况下，新的微服务实例地址（ip）和原来的地址一般是不一样的。在这种情况下，我们想实现实例的快速上下线，即快速感知实例状态。

这需要两方面的配置，一是 Eureka 客户端与实例配置，另一个就是这里要讨论的 Eureka 服务器的配置。在正常发布的过程中，我们会先启动一个新的实例，然后优雅关闭一个老实例，然后再启动一个新的，再关闭一个老的，以此类推，**滚动更新**。优雅关闭的时候，一般会从注册中心 Eureka 注销自己。但是有异常情况的时候，例如 JVM Stop-the-world，或者死锁等，优雅关闭可能失败。还有就是这些异常也可能导致心跳无法正常发送到 Eureka。

所以为了实现实例状态快速被其他实例感知，我们需要启动**Eureka 主动实例过期检查**，同时，**建议关闭掉自我保护机制**。主要因为：自我保护主要针对集群中网络出现问题，或者 Eureka 出现问题导致 Stop-the-world 并且无法恢复，或者压力过大，导致有很多实例无法发送心跳导致很多实例状态异常，但是实际实例还在正常工作的情况，不要让这些实例不参与负载均衡。启用自我保护的情况下，就会**停止对于实例的过期**。但是，如果出现这种情况，其实也代表很多实例无法读取注册中心了。并且还有一种情况就是，Eureka 重启，虽然不常见，但是对于镜像中其他的组件更新（例如 JDK 等）我们还是很频繁的。在我们的集群中， Eureka 集群压力不大（服务几百个实例），并且 Eureka 比较稳定，其实只需要考虑 Eureka 网络出问题的情况。我倾向于从客户端对于**实例缓存机制来解决这个问题**，如果返回实例列表为空，则使用上次的实例列表进行负载均衡，这样既能解决 Eureka 重启的情况，又能处理一些 Eureka 网络隔离的情况。


![](https://zhxhash-blog.oss-cn-beijing.aliyuncs.com/Spring%20Cloud%20%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF/2020.x/3-02.%20API%20%E7%BD%91%E5%85%B3%E9%9C%80%E8%A6%81%E8%80%83%E8%99%91%E7%9A%84%E9%97%AE%E9%A2%98.jpg)

对于 API 网关，我们使用 Spring Cloud Gatway。Spring Cloud Gateway 是基于 WebFlux（底层即 Project Reactor，基于 Netty 实现）的 API 网关。我们在使用的过程中，遇到并解决了以下一些问题：

 - Spring Cloud Gateway 是纯异步响应式的代码实现，API 网关涉及接口 Body 加密：我们需要对发过来的请求进行解密再发往微服务，之后对微服务返回的响应进行加密再返回给客户端，这就涉及到了 Body 读取与修改。在 Spring Cloud Gateway 中**如何实现 Body 的读取与修改**呢？这块要好好考虑实现，并且保证不能有内存泄漏。
 - API 网关需要鉴权，但是鉴权一般是单独有另一个微服务负责，API 网关需要调用这个微服务，如何在异步的环境下调用呢？
 - 发往微服务的每个请求，都是异步响应非阻塞的，所以可以**不像微服务调用微服务那样做线程隔离，限流也可以不使用客户端限流，而是每个微服务自己限流**。
 - 发往微服务的每个请求，是需要有**重试机制**的。
 - 发往微服务的每个请求，也需要做**实例和路径级别的断路机制**。


![](https://zhxhash-blog.oss-cn-beijing.aliyuncs.com/Spring%20Cloud%20%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF/2020.x/%E6%80%BB%E7%BB%93%E4%B8%8E%E5%90%8E%E7%BB%AD.png)


本小节我们继续针对注册中心 Eureka 以及 API 网关需要考虑的异常情况，设计问题等做了详细的说明与分析。接下来我们将开始入手开始开发我们的框架项目。

> **微信搜索“我的编程喵”关注公众号，每日一刷，轻松提升技术，斩获各种offer**：

![](https://zhxhash-blog.oss-cn-beijing.aliyuncs.com/%E5%85%AC%E4%BC%97%E5%8F%B7QR.gif)